---
- name: Install system packages
  apt:
    name:
      - python3-pip
      - python3-venv
      - python3-dev
      - libpq-dev
      - nginx
      - nodejs
      - npm
      - acl
    state: present

- name: Create app directory
  file:
    path: "{{ app_dir }}"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0755'

- name: Clone repository
  git:
    repo: "{{ repo_url }}"
    dest: "{{ app_dir }}"
    version: main
    force: yes

- name: Create virtualenv
  command: python3 -m venv venv
  args:
    chdir: "{{ app_dir }}/backend"
    creates: "{{ app_dir }}/backend/venv"

- name: Install python requirements
  pip:
    requirements: "{{ app_dir }}/requirements.txt"
    virtualenv: "{{ app_dir }}/backend/venv"

- name: Install frontend dependencies
  command: npm install
  args:
    chdir: "{{ app_dir }}/frontend"

- name: Build frontend
  command: npm run build
  args:
    chdir: "{{ app_dir }}/frontend"

- name: Run migrations
  command: "{{ app_dir }}/backend/venv/bin/python manage.py migrate"
  args:
    chdir: "{{ app_dir }}/backend"
  environment:
    DB_HOST: "{{ db_host }}"
    DB_PASSWORD: "{{ db_password }}"
    ADMIN_PASSWORD: "{{ admin_password }}"
    SECRET_KEY: "{{ secret_key }}"

- name: Collect static files
  command: "{{ app_dir }}/backend/venv/bin/python manage.py collectstatic --noinput"
  args:
    chdir: "{{ app_dir }}/backend"
  environment:
    DB_HOST: "{{ db_host }}"
    DB_PASSWORD: "{{ db_password }}"
    ADMIN_PASSWORD: "{{ admin_password }}"
    SECRET_KEY: "{{ secret_key }}"

- name: Configure Gunicorn service
  template:
    src: gunicorn.service.j2
    dest: /etc/systemd/system/gunicorn.service
  notify: Restart Gunicorn

- name: Configure Nginx
  template:
    src: nginx_backend.conf.j2
    dest: /etc/nginx/sites-available/backend
  notify: Restart Nginx

- name: Enable Nginx site
  file:
    src: /etc/nginx/sites-available/backend
    dest: /etc/nginx/sites-enabled/backend
    state: link
  notify: Restart Nginx

- name: Remove default Nginx site
  file:
    path: /etc/nginx/sites-enabled/default
    state: absent
  notify: Restart Nginx
